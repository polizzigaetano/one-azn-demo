<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="Description" content="AEM Workfront Utility" />
    <meta name="robots" content="noindex" />
    <base href="/" />

    <!-- ES Module Shims for better import map support -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.1/dist/es-module-shims.js"></script>

    <!-- Import map for Spectrum Web Components -->
    <script type="importmap">
      {
        "imports": {
          "@spectrum-web-components/theme/": "https://jspm.dev/@spectrum-web-components/theme/",
          "@spectrum-web-components/button/": "https://jspm.dev/@spectrum-web-components/button/",
          "@spectrum-web-components/badge/": "https://jspm.dev/@spectrum-web-components/badge/",
          "@spectrum-web-components/divider/": "https://jspm.dev/@spectrum-web-components/divider/",
          "@spectrum-web-components/checkbox/": "https://jspm.dev/@spectrum-web-components/checkbox/",
          "@spectrum-web-components/progress-circle/": "https://jspm.dev/@spectrum-web-components/progress-circle/",
          "@spectrum-web-components/action-button/": "https://jspm.dev/@spectrum-web-components/action-button/",
          "@spectrum-web-components/textfield/": "https://jspm.dev/@spectrum-web-components/textfield/",
          "@spectrum-web-components/picker/": "https://jspm.dev/@spectrum-web-components/picker/",
          "@spectrum-web-components/menu/": "https://jspm.dev/@spectrum-web-components/menu/",
          "@spectrum-web-components/avatar/": "https://jspm.dev/@spectrum-web-components/avatar/",
          "lit": "https://jspm.dev/lit"
        }
      }
    </script>

    <!-- Spectrum Web Components -->
    <script type="module">
      import 'https://jspm.dev/@spectrum-web-components/theme/sp-theme.js';
      import 'https://jspm.dev/@spectrum-web-components/theme/src/themes.js';
      import 'https://jspm.dev/@spectrum-web-components/button/sp-button.js';
      import 'https://jspm.dev/@spectrum-web-components/badge/sp-badge.js';
      import 'https://jspm.dev/@spectrum-web-components/divider/sp-divider.js';
      import 'https://jspm.dev/@spectrum-web-components/checkbox/sp-checkbox.js';
      import 'https://jspm.dev/@spectrum-web-components/progress-circle/sp-progress-circle.js';
      import 'https://jspm.dev/@spectrum-web-components/action-button/sp-action-button.js';
      import 'https://jspm.dev/@spectrum-web-components/textfield/sp-textfield.js';
      import 'https://jspm.dev/@spectrum-web-components/picker/sp-picker.js';
      import 'https://jspm.dev/@spectrum-web-components/menu/sp-menu.js';
      import 'https://jspm.dev/@spectrum-web-components/menu/sp-menu-item.js';
      import 'https://jspm.dev/@spectrum-web-components/avatar/sp-avatar.js';
    </script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: adobe-clean, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #f5f5f5;
        height: 100%;
      }

      sp-theme {
        display: block;
        height: 100%;
      }

      .container {
        max-width: 860px;
        margin: 0 auto;
        padding: 32px 24px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
        color: #2c2c2c;
      }

      .filter-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
      }

      .filter-toggle svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }

      .filter-toggle span {
        font-size: 14px;
        color: #2c2c2c;
      }

      .login-panel {
        background: white;
        border-radius: 8px;
        padding: 48px;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }

      .login-panel h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 16px;
        color: #2c2c2c;
      }

      .login-panel p {
        font-size: 14px;
        color: #6e6e6e;
        margin: 0 0 24px;
      }

      .task-card {
        background: white;
        border-radius: 4px;
        padding: 20px 24px;
        margin-bottom: 16px;
        border: 1px solid #e1e1e1;
        transition: box-shadow 0.2s;
        cursor: pointer;
      }

      .task-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .task-project {
        font-size: 14px;
        color: #6e6e6e;
        margin: 0 0 8px;
      }

      .task-name {
        font-size: 16px;
        font-weight: 700;
        color: #2c2c2c;
        margin: 0 0 12px;
      }

      .task-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 14px;
        color: #6e6e6e;
      }

      .task-due-date {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .task-status {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-indicator.complete {
        background-color: #2d9d78;
      }

      .status-indicator.in-progress {
        background-color: #e68619;
      }

      .status-indicator.pending {
        background-color: #6e6e6e;
      }

      .empty-state {
        background: white;
        border-radius: 8px;
        padding: 48px;
        text-align: center;
        color: #6e6e6e;
      }

      .loading {
        display: flex;
        justify-content: center;
        padding: 48px;
      }

      /* Task Detail View */
      .task-detail {
        background: white;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 24px;
      }

      .back-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 24px;
        border: none;
        background: white;
        cursor: pointer;
        font-size: 16px;
        color: #2c2c2c;
        border-bottom: 1px solid #e1e1e1;
        width: 100%;
        text-align: left;
      }

      .back-button:hover {
        background: #f5f5f5;
      }

      .back-button svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      .detail-content {
        padding: 24px;
      }

      .detail-section {
        margin-bottom: 32px;
      }

      .detail-section:last-child {
        margin-bottom: 0;
      }

      .detail-label {
        font-size: 12px;
        color: #6e6e6e;
        margin: 0 0 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-value {
        font-size: 14px;
        color: #2c2c2c;
        margin: 0;
        line-height: 1.5;
      }

      .detail-value.large {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 24px;
      }

      .detail-value a,
      .detail-value a:visited,
      .detail-value a:hover,
      .detail-value a:active {
        color: #2c2c2c;
        text-decoration: none;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .detail-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .status-dropdown {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: 1px solid #e1e1e1;
        border-radius: 4px;
        background: white;
        font-size: 14px;
        cursor: pointer;
      }

      .status-dropdown:hover {
        border-color: #b8b8b8;
      }

      .assignee-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .assignee-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #e1e1e1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6e6e6e;
        font-weight: 600;
        font-size: 14px;
      }

      .assignee-info {
        flex: 1;
      }

      .assignee-name {
        font-size: 14px;
        color: #2c2c2c;
        font-weight: 600;
        margin: 0;
      }

      .assignee-role {
        font-size: 12px;
        color: #6e6e6e;
        margin: 0;
      }

      .aem-details {
        background: #f5f5f5;
        padding: 24px;
        border-radius: 4px;
        margin-top: 24px;
      }

      .aem-details h3 {
        font-size: 16px;
        font-weight: 700;
        margin: 0 0 20px;
        color: #2c2c2c;
      }

      .approval-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #e1e1e1;
      }

      .approval-button-container {
        display: flex;
        justify-content: center;
      }

      .approval-status {
        text-align: center;
        margin-top: 12px;
        font-size: 14px;
      }

      .approval-status.success {
        color: #2d9d78;
      }

      .approval-status.error {
        color: #d7373f;
      }

      .field-with-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 16px;
      }

      .field-with-actions sp-textfield {
        flex: 1;
      }

      .field-actions {
        display: flex;
        gap: 4px;
      }

      .icon-button {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e1e1e1;
        background: white;
        border-radius: 4px;
        cursor: pointer;
      }

      .icon-button:hover {
        background: #f5f5f5;
      }

      .icon-button svg {
        width: 16px;
        height: 16px;
        fill: #6e6e6e;
      }

      helix-sidekick { display: none }
    </style>
    <title>Workfront - My Work</title>
  </head>

  <body>
    <sp-theme system="spectrum" scale="medium" color="light">
      <div class="container">
        <div class="header">
          <h1>My Work</h1>
          <div class="filter-toggle" id="filterToggle">
            <svg viewBox="0 0 18 18" role="img" aria-label="Filter">
              <path d="M1.5 3h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1 0-1.5zm3 6h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1 0-1.5zm3 6h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1 0-1.5z"/>
            </svg>
            <span id="filterText">Filter by current page</span>
          </div>
        </div>

        <div id="loginPanel" class="login-panel" style="display: none;">
          <h2>Sign in to view your tasks</h2>
          <p>Connect your Workfront account to see your assigned tasks</p>
          <sp-button id="loginBtn" variant="accent">Sign in to Workfront</sp-button>
        </div>

        <div id="loadingPanel" class="loading" style="display: none;">
          <sp-progress-circle indeterminate></sp-progress-circle>
        </div>

        <div id="taskList"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
          <p>No tasks found</p>
        </div>

        <div id="taskDetail" class="task-detail" style="display: none;">
          <button class="back-button" id="backButton">
            <svg viewBox="0 0 18 18" role="img" aria-label="Back">
              <path d="M11.5 15.25a.74.74 0 0 1-.53-.22l-5.5-5.5a.75.75 0 0 1 0-1.06l5.5-5.5a.75.75 0 1 1 1.06 1.06L6.56 9.5l5.47 5.47a.75.75 0 0 1-.53 1.28z"/>
            </svg>
            Back
          </button>
          <div class="detail-content" id="detailContent">
            <!-- Content will be dynamically populated -->
          </div>
        </div>
      </div>
    </sp-theme>

    <script type="module" src="/tools/sidekick/workfront/index.js"></script>
    <script>
      const library = document.createElement('sidekick-library')
      library.config = {
        base: '/tools/sidekick/workfront/library.json',
      }

      document.body.prepend(library)
    </script>

    <script>
      // Workfront OAuth2 Authorization Code flow with PKCE (no client secret).
      //
      // Docs:
      // - PKCE flow: https://experienceleague.adobe.com/en/docs/workfront/using/adobe-workfront-api/api-notes/oauth-app-pkce-flow
      // - Authorize/token endpoints: https://experienceleague.adobe.com/en/docs/workfront/using/adobe-workfront-api/api-notes/oauth-app-code-token-flow
      //
      // Defaults can be overridden via query params:
      // - wf_base: https://<instance>
      // - client_id: <oauth app client id>
      // - referrer: URL to filter tasks by (use document.referrer automatically if not provided)

      const STORAGE_PREFIX = 'wf_pkce_v1:'
      const LOCAL_TOKEN_KEY = `${STORAGE_PREFIX}token`
      const FILTER_ENABLED_KEY = `${STORAGE_PREFIX}filter_enabled`

      let filterEnabled = localStorage.getItem(FILTER_ENABLED_KEY) === 'true'

      function $(id) {
        return document.getElementById(id)
      }

      function showPanel(panelId) {
        $('loginPanel').style.display = 'none'
        $('loadingPanel').style.display = 'none'
        $('taskList').style.display = 'none'
        $('emptyState').style.display = 'none'
        $('taskDetail').style.display = 'none'
        
        // Hide/show header and filter toggle
        const header = document.querySelector('.header')
        if (header) {
          if (panelId === 'taskDetail') {
            header.style.display = 'none'
          } else {
            header.style.display = 'flex'
          }
        }

        if (panelId) {
          $(panelId).style.display = ''
        }
      }

      function base64UrlEncode(arrayBuffer) {
        const bytes = new Uint8Array(arrayBuffer)
        let binary = ''
        for (let i = 0; i < bytes.byteLength; i += 1) binary += String.fromCharCode(bytes[i])
        const base64 = btoa(binary)
        return base64.replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_')
      }

      async function sha256(text) {
        const data = new TextEncoder().encode(text)
        return await crypto.subtle.digest('SHA-256', data)
      }

      function randomUrlSafeString(length) {
        const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~'
        const values = new Uint8Array(length)
        crypto.getRandomValues(values)
        let result = ''
        for (let i = 0; i < values.length; i += 1) {
          result += charset[values[i] % charset.length]
        }
        return result
      }

      function getConfig() {
        const params = new URLSearchParams(window.location.search)
        const wfBase = (params.get('wf_base') || 'https://adobeemea78-16072401.testdrive.workfront.com').replace(/\/$/, '')
        const clientId = params.get('client_id') || '906d49398c39cd15c12ae845063313c1'
        const redirectUrl = new URL(window.location.href)
        redirectUrl.search = ''
        redirectUrl.hash = ''
        const redirectUri = redirectUrl.toString()
        return { wfBase, clientId, redirectUri }
      }

      function getReferrerFilter() {
        if (!filterEnabled) return null
        
        const params = new URLSearchParams(window.location.search)
        const referrer = params.get('referrer') || document.referrer
        return referrer || null
      }

      function persist(key, value) {
        sessionStorage.setItem(`${STORAGE_PREFIX}${key}`, value)
      }

      function recall(key) {
        return sessionStorage.getItem(`${STORAGE_PREFIX}${key}`)
      }

      function persistLocalToken(tokenObj) {
        localStorage.setItem(LOCAL_TOKEN_KEY, JSON.stringify(tokenObj))
      }

      function recallLocalTokenRaw() {
        return localStorage.getItem(LOCAL_TOKEN_KEY)
      }

      function clearAuthSession() {
        Object.keys(sessionStorage)
          .filter((k) => k.startsWith(STORAGE_PREFIX))
          .forEach((k) => sessionStorage.removeItem(k))
        localStorage.removeItem(LOCAL_TOKEN_KEY)
      }

      async function startAuth() {
        const { wfBase, clientId, redirectUri } = getConfig()
        const state = randomUrlSafeString(24)
        const codeVerifier = randomUrlSafeString(96) // RFC 7636: 43-128
        const codeChallenge = base64UrlEncode(await sha256(codeVerifier))

        persist('state', state)
        persist('code_verifier', codeVerifier)
        persist('redirect_uri', redirectUri)
        persist('wf_base', wfBase)
        persist('client_id', clientId)

        const authorizeUrl = new URL('/integrations/oauth2/authorize', wfBase)
        authorizeUrl.searchParams.set('client_id', clientId)
        authorizeUrl.searchParams.set('redirect_uri', redirectUri)
        authorizeUrl.searchParams.set('response_type', 'code')
        authorizeUrl.searchParams.set('state', state)
        authorizeUrl.searchParams.set('code_challenge', codeChallenge)
        authorizeUrl.searchParams.set('code_challenge_method', 'S256')

        window.location.assign(authorizeUrl.toString())
      }

      async function exchangeCodeForToken(code) {
        const wfBase = recall('wf_base')
        const clientId = recall('client_id')
        const redirectUri = recall('redirect_uri')
        const codeVerifier = recall('code_verifier')

        if (!wfBase || !clientId || !redirectUri || !codeVerifier) {
          throw new Error('Missing PKCE session values (try "Clear session" and sign in again).')
        }

        const tokenUrl = new URL('/integrations/oauth2/api/v1/token', wfBase)
        const body = new URLSearchParams()
        body.set('grant_type', 'authorization_code')
        body.set('redirect_uri', redirectUri)
        body.set('code', code)
        body.set('client_id', clientId)
        body.set('code_verifier', codeVerifier)

        const res = await fetch(tokenUrl.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
        })

        const data = await res.json().catch(() => ({}))
        if (!res.ok) {
          throw new Error(`Token request failed (${res.status}).\n${JSON.stringify(data, null, 2)}`)
        }

        const withMeta = { ...data, obtained_at: Date.now() }
        persist('token', JSON.stringify(withMeta))
        persistLocalToken(withMeta)
        return withMeta
      }

      function getStoredToken() {
        const raw = recallLocalTokenRaw() || recall('token')
        if (!raw) return null
        try {
          return JSON.parse(raw)
        } catch (e) {
          return null
        }
      }

      function shouldRefreshToken(token) {
        const expiresIn = token && Number(token.expires_in)
        const obtainedAt = token && Number(token.obtained_at)
        if (!expiresIn || !obtainedAt) return false
        const refreshAt = obtainedAt + (expiresIn * 1000) - (60 * 1000)
        return Date.now() >= refreshAt
      }

      async function refreshAccessToken() {
        const token = getStoredToken()
        const wfBase = recall('wf_base') || getConfig().wfBase
        const clientId = recall('client_id') || getConfig().clientId
        const refreshToken = token && token.refresh_token ? token.refresh_token : null

        if (!refreshToken) throw new Error('No refresh_token available; re-authentication required.')

        const tokenUrl = new URL('/integrations/oauth2/api/v1/token', wfBase)
        const body = new URLSearchParams()
        body.set('grant_type', 'refresh_token')
        body.set('client_id', clientId)
        body.set('refresh_token', refreshToken)

        const res = await fetch(tokenUrl.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
        })

        const data = await res.json().catch(() => ({}))
        if (!res.ok) {
          throw new Error(`Refresh request failed (${res.status}).\n${JSON.stringify(data, null, 2)}`)
        }

        const merged = {
          ...token,
          ...data,
          refresh_token: data.refresh_token || refreshToken,
          obtained_at: Date.now(),
        }
        persist('token', JSON.stringify(merged))
        persistLocalToken(merged)
        return merged
      }

      function normalizeTasksResponse(json) {
        if (!json) return []
        if (Array.isArray(json.data)) return json.data
        if (json.data && Array.isArray(json.data.data)) return json.data.data
        if (json.data && typeof json.data === 'object') return Object.values(json.data)
        return []
      }

      async function fetchTasks() {
        let token = getStoredToken()
        const wfBase = recall('wf_base') || getConfig().wfBase
        if (token && shouldRefreshToken(token)) {
          token = await refreshAccessToken()
        }
        const accessToken = token && token.access_token ? token.access_token : null
        const referrer = getReferrerFilter()

        if (!accessToken) {
          throw new Error('No access_token found. Authenticate first.')
        }

        const tasksUrl = new URL('/attask/api/v15.0/task/search', wfBase)
        tasksUrl.searchParams.set('fields', 'ID,name,project:name,plannedCompletionDate,status,percentComplete')
        tasksUrl.searchParams.set('$$LIMIT', '50')
        
        if (referrer) {
          tasksUrl.searchParams.set('DE:aem_workfront_integration_preview_url_Mod', 'eq')
          tasksUrl.searchParams.set('DE:aem_workfront_integration_preview_url', referrer)
          tasksUrl.searchParams.set('status_Mod', 'notin')
          tasksUrl.searchParams.set('status', 'CPL,CLS,DED')
        }
        
        tasksUrl.searchParams.set('sessionID', accessToken)

        const proxyUrl = new URL('https://cors.cpilsworth.workers.dev/')
        proxyUrl.searchParams.set('target', tasksUrl.toString())

        const res = await fetch(proxyUrl.toString(), { method: 'GET' })
        const json = await res.json().catch(() => ({}))
        if (!res.ok) {
          throw new Error(`Task search failed (${res.status}).\n${JSON.stringify(json, null, 2)}`)
        }

        return normalizeTasksResponse(json)
      }

      async function fetchTaskDetail(taskId) {
        let token = getStoredToken()
        const wfBase = recall('wf_base') || getConfig().wfBase
        if (token && shouldRefreshToken(token)) {
          token = await refreshAccessToken()
        }
        const accessToken = token && token.access_token ? token.access_token : null

        if (!accessToken) {
          throw new Error('No access_token found. Authenticate first.')
        }

        // Fetch task with all details including assignments and custom fields
        // Note: numberOfDocuments is not supported in API v15.0
        const tasksUrl = new URL(`/attask/api/v15.0/task/${taskId}`, wfBase)
        const fieldsParam = 'ID,name,description,project:name,plannedCompletionDate,status,percentComplete,assignments:assignedTo:name,assignments:role:name,DE:aem_workfront_integration_preview_url,DE:aem_workfront_integration_publish_url'
        tasksUrl.searchParams.set('fields', fieldsParam)
        tasksUrl.searchParams.set('sessionID', accessToken)

        const proxyUrl = new URL('https://cors.cpilsworth.workers.dev/')
        proxyUrl.searchParams.set('target', tasksUrl.toString())

        const res = await fetch(proxyUrl.toString(), { method: 'GET' })
        const json = await res.json().catch(() => ({}))
        if (!res.ok) {
          throw new Error(`Task detail fetch failed (${res.status}).\n${JSON.stringify(json, null, 2)}`)
        }

        return json.data || json
      }

      function getStatusInfo(task) {
        const status = task.status || ''
        const percent = Number(task.percentComplete) || 0

        if (status === 'CPL' || percent === 100) {
          return { label: 'Complete', className: 'complete' }
        } else if (status === 'INP' || percent > 0) {
          return { label: 'In Progress', className: 'in-progress' }
        } else {
          return { label: 'Pending', className: 'pending' }
        }
      }

      function formatDate(dateString) {
        if (!dateString) return ''
        try {
          // Fix Workfront's non-standard date format: replace :000 with .000 for milliseconds
          // Example: 2025-09-03T07:50:00:000-0600 -> 2025-09-03T07:50:00.000-0600
          const normalizedDateString = dateString.replace(/(\d{2}):(\d{3})/, '$1.$2')
          
          const date = new Date(normalizedDateString)
          
          // Check if date is valid
          if (isNaN(date.getTime())) {
            return dateString
          }
          
          return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })
        } catch (e) {
          return dateString
        }
      }

      function renderTasks(tasks) {
        const container = $('taskList')
        container.innerHTML = ''

        if (!tasks || tasks.length === 0) {
          showPanel('emptyState')
          return
        }

        tasks.forEach((task) => {
          const card = document.createElement('div')
          card.className = 'task-card'

          const projectName = task.project?.name || 'No project'
          const taskName = task.name || 'Untitled task'
          const dueDate = formatDate(task.plannedCompletionDate)
          const statusInfo = getStatusInfo(task)

          card.innerHTML = `
            <div class="task-project">${projectName}</div>
            <div class="task-name">${taskName}</div>
            <div class="task-meta">
              ${dueDate ? `<div class="task-due-date">Due date ${dueDate}</div>` : ''}
              <div class="task-status">
                <span class="status-indicator ${statusInfo.className}"></span>
                <span>${statusInfo.label}</span>
              </div>
            </div>
          `

          // Make card clickable
          card.addEventListener('click', async () => {
            await showTaskDetail(task.ID)
          })

          container.appendChild(card)
        })

        showPanel('taskList')
      }

      function getInitials(name) {
        if (!name) return '?'
        const parts = name.split(' ').filter(part => part.length > 0)
        if (parts.length >= 2) {
          return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
        }
        if (parts.length === 1 && parts[0].length > 0) {
          return parts[0].substring(0, 2).toUpperCase()
        }
        return '?'
      }

      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      function escapeJsString(text) {
        if (!text) return ''
        return text
          .replace(/\\/g, '\\\\')
          .replace(/'/g, "\\'")
          .replace(/"/g, '\\"')
          .replace(/\n/g, '\\n')
          .replace(/\r/g, '\\r')
      }

      function renderTaskDetail(task) {
        const statusInfo = getStatusInfo(task)
        const dueDate = formatDate(task.plannedCompletionDate)
        const description = task.description || 'No description provided.'
        const projectName = task.project?.name || 'No project'
        const wfBase = recall('wf_base') || getConfig().wfBase
        const taskUrl = new URL(`/task/${task.ID}/overview`, wfBase).toString()
        
        // Get assignees
        const assignments = task.assignments || []
        const assigneesHtml = assignments.length > 0 
          ? assignments.map(assignment => {
              const name = assignment.assignedTo?.name || 'Unassigned'
              const role = assignment.role?.name || 'No role specified'
              const initials = getInitials(name)
              return `
                <div class="assignee-item">
                  <div class="assignee-avatar">${initials}</div>
                  <div class="assignee-info">
                    <p class="assignee-name">${escapeHtml(name)}</p>
                    <p class="assignee-role">${escapeHtml(role)}</p>
                  </div>
                </div>
              `
            }).join('')
          : '<p class="detail-value">No assignees</p>'

        // Get AEM custom fields
        const previewUrl = task['DE:aem_workfront_integration_preview_url'] || ''
        const publishUrl = task['DE:aem_workfront_integration_publish_url'] || ''

        const detailContent = $('detailContent')
        detailContent.innerHTML = `
          <div class="detail-section">
            <p class="detail-label">Title</p>
            <h2 class="detail-value large">
              <a href="${escapeHtml(taskUrl)}" target="_workfront" rel="noopener noreferrer">
                ${escapeHtml(task.name || 'Untitled task')}
              </a>
            </h2>
          </div>

          <div class="detail-section">
            <p class="detail-label">Description</p>
            <p class="detail-value">${escapeHtml(description)}</p>
          </div>

          <div class="detail-grid">
            <div class="detail-field">
              <p class="detail-label">Due date</p>
              <p class="detail-value">${dueDate || 'No due date'}</p>
            </div>
            <div class="detail-field">
              <p class="detail-label">Status</p>
              <div class="status-dropdown">
                <span class="status-indicator ${statusInfo.className}"></span>
                <span>${statusInfo.label}</span>
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                  <path d="M6 8.5L2.5 5h7L6 8.5z"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <p class="detail-label">Project</p>
            <p class="detail-value">${escapeHtml(projectName)}</p>
          </div>

          <div class="detail-section">
            <p class="detail-label">Assignees</p>
            ${assigneesHtml}
          </div>

          <div class="aem-details">
            <h3>AEM Details</h3>
            
            <div class="detail-field">
              <p class="detail-label">Preview URL</p>
              <div class="field-with-actions">
                <sp-textfield 
                  placeholder="Enter preview URL" 
                  value="${escapeHtml(previewUrl)}"
                  readonly
                ></sp-textfield>
                <div class="field-actions">
                  <button class="icon-button" title="Copy" onclick="navigator.clipboard.writeText('${escapeJsString(previewUrl)}')">
                    <svg viewBox="0 0 18 18" fill="currentColor">
                      <path d="M13.5 2h-8A1.5 1.5 0 0 0 4 3.5V4H3.5A1.5 1.5 0 0 0 2 5.5v9A1.5 1.5 0 0 0 3.5 16h8a1.5 1.5 0 0 0 1.5-1.5V14h.5a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 13.5 2zM11.5 14.5h-8v-9H4v7a1.5 1.5 0 0 0 1.5 1.5h6zm2-2h-8v-9h8z"/>
                    </svg>
                  </button>
                  <button class="icon-button" title="Edit">
                    <svg viewBox="0 0 18 18" fill="currentColor">
                      <path d="M16.1 2.9c-.3-.3-.7-.4-1.1-.4s-.8.1-1.1.4l-10 10c-.1.1-.2.2-.2.4l-.7 3c-.1.3 0 .5.2.7.1.1.3.2.5.2h.2l3-.7c.1 0 .3-.1.4-.2l10-10c.6-.6.6-1.6 0-2.2z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="detail-field">
              <p class="detail-label">Publish URL</p>
              <div class="field-with-actions">
                <sp-textfield 
                  placeholder="Enter publish URL" 
                  value="${escapeHtml(publishUrl)}"
                  readonly
                ></sp-textfield>
                <div class="field-actions">
                  <button class="icon-button" title="Edit">
                    <svg viewBox="0 0 18 18" fill="currentColor">
                      <path d="M16.1 2.9c-.3-.3-.7-.4-1.1-.4s-.8.1-1.1.4l-10 10c-.1.1-.2.2-.2.4l-.7 3c-.1.3 0 .5.2.7.1.1.3.2.5.2h.2l3-.7c.1 0 .3-.1.4-.2l10-10c.6-.6.6-1.6 0-2.2z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          ${renderApprovalButton(task, previewUrl, publishUrl)}
        `
      }

      function isTaskAssociatedWithCurrentPage(previewUrl, publishUrl) {
        const candidateUrls = [previewUrl, publishUrl].filter(Boolean)
        if (!candidateUrls.length) {
          return false
        }
        
        const params = new URLSearchParams(window.location.search)
        const referrer = params.get('referrer') || document.referrer
        
        if (!referrer) {
          return false
        }
        
        const referrerUrlObj = new URL(referrer)

        return candidateUrls.some((candidateUrl) => {
          // Compare the preview/publish URL with the referrer
          try {
            const candidateUrlObj = new URL(candidateUrl)

            // Compare pathname and hostname (ignore protocol, query params, and hash)
            return candidateUrlObj.hostname === referrerUrlObj.hostname &&
                 candidateUrlObj.pathname === referrerUrlObj.pathname
          } catch (e) {
            // If URL parsing fails, do a simple string comparison
            return candidateUrl === referrer || referrer.includes(candidateUrl) || candidateUrl.includes(referrer)
          }
        })
      }

      function renderApprovalButton(task, previewUrl, publishUrl) {
        const isAssociated = isTaskAssociatedWithCurrentPage(previewUrl, publishUrl)
        
        if (!isAssociated) {
          return ''
        }

        return `
          <div class="approval-section">
            <div class="approval-button-container">
              <sp-button id="requestApprovalBtn" variant="accent" size="l">Request approval</sp-button>
            </div>
            <div id="approvalStatus" class="approval-status"></div>
          </div>
        `
      }

      async function requestApproval(task) {
        const config = getConfig()
        const params = new URLSearchParams(window.location.search)
        const referrer = params.get('referrer') || document.referrer
        
        const payload = {
          ...config,
          referrer,
          task: {
            id: task.ID,
            name: task.name,
            projectName: task.project?.name,
            previewUrl: task['DE:aem_workfront_integration_preview_url'],
            publishUrl: task['DE:aem_workfront_integration_publish_url']
          }
        }

        const approvalBtn = $('requestApprovalBtn')
        const statusEl = $('approvalStatus')
        
        try {
          approvalBtn.disabled = true
          approvalBtn.textContent = 'Requesting...'
          statusEl.className = 'approval-status'
          statusEl.textContent = ''

          const webhookUrl = 'https://hook.fusion.adobe.com/t25jws5pn0cq224nooxlmquf49t6eqrx'
          const proxyUrl = new URL('https://cors.cpilsworth.workers.dev/')
          proxyUrl.searchParams.set('target', webhookUrl)

          const response = await fetch(proxyUrl.toString(), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          })

          if (response.ok) {
            statusEl.className = 'approval-status success'
            statusEl.textContent = 'Approval request sent successfully!'
            approvalBtn.textContent = 'Request sent'
          } else {
            throw new Error(`Request failed with status ${response.status}`)
          }
        } catch (e) {
          console.error('Failed to request approval:', e)
          statusEl.className = 'approval-status error'
          statusEl.textContent = `Failed to send request: ${e.message}`
          approvalBtn.disabled = false
          approvalBtn.textContent = 'Request approval'
        }
      }

      // Store current task for approval request
      let currentDetailTask = null

      async function showTaskDetail(taskId) {
        showPanel('loadingPanel')
        try {
          const task = await fetchTaskDetail(taskId)
          currentDetailTask = task
          renderTaskDetail(task)
          showPanel('taskDetail')
          
          // Attach approval button event listener if the button exists
          const approvalBtn = $('requestApprovalBtn')
          if (approvalBtn) {
            approvalBtn.addEventListener('click', () => {
              if (currentDetailTask) {
                requestApproval(currentDetailTask)
              }
            })
          }
        } catch (e) {
          console.error('Failed to load task detail:', e)
          alert(`Failed to load task details: ${e.message}`)
          showPanel('taskList')
        }
      }

      async function loadAndRenderTasks() {
        showPanel('loadingPanel')
        try {
          const tasks = await fetchTasks()
          renderTasks(tasks)
        } catch (e) {
          console.error('Failed to load tasks:', e)
          showPanel('emptyState')
          $('emptyState').innerHTML = `<p>Failed to load tasks</p><p style="color: #d7373f; font-size: 12px;">${e.message}</p>`
        }
      }

      async function maybeHandleCallback() {
        const url = new URL(window.location.href)
        const code = url.searchParams.get('code')
        const returnedState = url.searchParams.get('state')
        const error = url.searchParams.get('error')
        const errorDescription = url.searchParams.get('error_description')

        if (error) {
          console.error('Authorization error:', error, errorDescription)
          showPanel('loginPanel')
          return
        }

        if (!code) return

        const expectedState = recall('state')
        if (expectedState && (!returnedState || returnedState !== expectedState)) {
          console.error('State mismatch (possible CSRF)')
          showPanel('loginPanel')
          return
        }

        showPanel('loadingPanel')
        try {
          await exchangeCodeForToken(code)
          await loadAndRenderTasks()

          // Clean up URL
          url.searchParams.delete('code')
          url.searchParams.delete('state')
          url.searchParams.delete('domain')
          url.searchParams.delete('lane')
          url.searchParams.delete('error')
          url.searchParams.delete('error_description')
          window.history.replaceState({}, document.title, url.toString())
        } catch (e) {
          console.error('Authentication failed:', e)
          showPanel('loginPanel')
        }
      }

      function updateFilterUI() {
        const filterText = $('filterText')
        const filterToggle = $('filterToggle')
        
        if (filterEnabled) {
          filterText.textContent = 'âœ“ Filter by current page'
          filterToggle.style.color = '#1473e6'
        } else {
          filterText.textContent = 'Filter by current page'
          filterToggle.style.color = '#6e6e6e'
        }
      }

      function initUI() {
        $('loginBtn').addEventListener('click', async () => {
          await startAuth()
        })

        $('filterToggle').addEventListener('click', () => {
          filterEnabled = !filterEnabled
          localStorage.setItem(FILTER_ENABLED_KEY, filterEnabled.toString())
          updateFilterUI()
          
          if (getStoredToken()) {
            loadAndRenderTasks()
          }
        })

        $('backButton').addEventListener('click', () => {
          showPanel('taskList')
        })

        updateFilterUI()
      }

      ;(async () => {
        initUI()
        await maybeHandleCallback()
        
        const token = getStoredToken()
        console.dir(token);
        if (token) {
          await loadAndRenderTasks()
        } else {
          showPanel('loginPanel')
        }
      })()
    </script>
  </body>
</html>
